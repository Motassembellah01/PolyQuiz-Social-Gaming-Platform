<div class="chat-layout">
    <section class="chat-shell">
        <header class="chat-header">
            <button *ngIf="generalChatService.currentChannel" class="nav-btn" type="button" (click)="backToChannels()">
                <i class="material-icons">keyboard_arrow_left</i>
                <span>{{ 'CHAT.ALL_CHANNELS' | translate }}</span>
            </button>
            <span class="title-icon material-icons">forum</span>
            <h1
                class="title-chat"
                [ngClass]="{
                    'color-blue': this.accountService.theme === 'light' || this.accountService.theme === 'valentines',
                    'color-brown': this.accountService.theme === 'christmas' || this.accountService.theme === 'dark',
                }"
            >
                {{ generalChatService.currentChannel ? generalChatService.currentChannel.chatRoomName : ('CHAT.CHANNELS' | translate) }}
            </h1>

            <div class="header-actions" *ngIf="!generalChatService.currentChannel">
                <button mat-icon-button type="button" (click)="openExternalChat()" aria-label="Open external chat window">
                    <i class="material-icons">pin_invoke</i>
                </button>
                <button mat-icon-button type="button" (click)="toggleChat(); backToChannels()" aria-label="Close chat panel">
                    <i class="material-icons">close</i>
                </button>
            </div>
        </header>

        <ng-container *ngIf="!generalChatService.currentChannel; else activeChannel">
            <div class="toolbar">
                <button mat-stroked-button class="channel-btn pointer" (click)="toggleAddChannel()" [class.toggled]="isAddOpen">
                    <i class="material-icons">add_circle_outline</i>
                    <span>Create</span>
                </button>
                <button mat-stroked-button class="channel-btn pointer" (click)="toggleModifyChannel()" [class.toggled]="isModifyOpen">
                    <i class="material-icons">edit_note</i>
                    <span>Manage</span>
                </button>
                <button mat-stroked-button class="channel-btn pointer" (click)="toggleSearchChannel()" [class.toggled]="isSearchOpen">
                    <i class="material-icons">manage_search</i>
                    <span>Discover</span>
                </button>
            </div>

            <div *ngIf="isAddOpen" class="utility-row">
                <input class="utility-input" [(ngModel)]="newChannelName" placeholder="{{ 'CHAT.NEW_CHANNEL' | translate }}" maxlength="10" required />
                <span class="countdown">{{ newChannelName.length || 0 }}/10</span>
                <button mat-mini-fab type="button" class="icon-confirm" (click)="createChannel()" [disabled]="!newChannelName || newChannelName.trim() === ''">
                    <i class="material-icons">add</i>
                </button>
            </div>

            <div *ngIf="isSearchOpen" class="utility-row">
                <input type="text" class="utility-input" [(ngModel)]="searchTerm" placeholder="{{ 'CHAT.SEARCH' | translate }}" (input)="onSearch()" />
            </div>

            <ul *ngIf="!isSearchOpen" class="channel-list">
                <li *ngFor="let channel of joinedChatRooms" class="channel-item" [class.disabled-click]="isModifyOpen" (click)="!isModifyOpen ? selectChannel(channel) : null">
                    <div class="channel-body">
                        <span class="channel-name"><i class="material-icons channel-icon">tag</i>{{ channel.chatRoomName }}</span>
                        <span class="last-message">
                            {{ channel.messages.length > 0 ? channel.messages[channel.messages.length - 1].message.data : 'No messages yet' }}
                        </span>
                    </div>
                    <button
                        *ngIf="isModifyOpen && channel.chatRoomName !== 'general'"
                        class="action-button delete-button pointer"
                        type="button"
                        (click)="removeChannel(channel.chatRoomName)"
                    >
                        <i class="material-icons">delete</i>
                    </button>
                </li>
            </ul>

            <ul *ngIf="isSearchOpen" class="channel-list">
                <li *ngFor="let channel of filteredChannels" class="channel-item">
                    <span class="channel-name"><i class="material-icons channel-icon">travel_explore</i>{{ channel }}</span>
                    <button (click)="joinChannel(channel)" *ngIf="!isChannelJoined(channel)" type="button" class="join-button">
                        <i class="material-icons">login</i>
                        {{ 'CHAT.JOIN' | translate }}
                    </button>
                    <button *ngIf="isChannelJoined(channel)" class="joined-button" type="button" disabled>
                        <i class="material-icons">check_circle</i>
                        {{ 'CHAT.JOINED' | translate }}
                    </button>
                </li>
            </ul>
        </ng-container>

        <ng-template #activeChannel>
            <div class="messages" #chatZone>
                <ng-container *ngFor="let msg of generalChatService.mappedMessages">
                    <div
                        class="message-row"
                        [class.own]="msg.playerName === accountService.account.pseudonym"
                        *ngIf="
                            msg.playerName === accountService.account.pseudonym ||
                            (!isBlocked(msg.userId) && !isBlockedByHim(msg.userId))
                        "
                    >
                        <img *ngIf="msg.playerName !== accountService.account.pseudonym" [src]="msg.avatarUrl" alt="avatar" class="avatar" />
                        <div class="message-card">
                            <header class="message-meta">
                                <span class="message-author">
                                    <i class="material-icons author-icon">{{ msg.playerName === accountService.account.pseudonym ? 'person' : 'alternate_email' }}</i>
                                    {{ msg.playerName }}
                                </span>
                                <span class="message-time italic">{{ msg.time }}</span>
                            </header>
                            <p class="message-content">{{ msg.data }}</p>
                        </div>
                    </div>
                </ng-container>
            </div>

            <footer class="message-input">
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                    <textarea
                        cdkTextareaAutosize
                        cdkAutosizeMinRows="1"
                        cdkAutosizeMaxRows="4"
                        class="italic input-field"
                        id="chat-field"
                        name="inputMessage"
                        (focus)="changeTypingState()"
                        (blur)="changeTypingState()"
                        [(ngModel)]="this.newMessage"
                        (keydown)="onEntryKey($event)"
                        matInput
                        #input
                        maxlength="200"
                        placeholder="Type your message..."
                    ></textarea>
                    <button mat-icon-button matSuffix type="button" class="send-button" (click)="sendMessage()" aria-label="Send message">
                        <mat-icon [ngClass]="{ pink: input.value.length !== 0 }">send</mat-icon>
                    </button>
                    <mat-hint align="end">{{ input.value.length }}/200 </mat-hint>
                </mat-form-field>
            </footer>
        </ng-template>
    </section>
</div>
